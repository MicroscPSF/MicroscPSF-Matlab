function PSF = MicroPSF(params)
%MICROPSF Compute the 3D PSF model described by Gibson and Lanni (JOSA 1992).
%   PSF = MICROPSF(params) return a 3D PSF given parameters
%
%   Parameters include:
%   (1) image properties
%           'size'  -  the size of the 3D PSF, e.g. params.size = [256 256 128];
%   (2) precision control
%           'numBasis'      - the number of approximation basis, default 'size(1)/2'
%           'numSamp'       - the number of sampling to determine the basis coefficients
%           'fastcom'       - fast approximation of Bessel functions, default 0
%           'basis'         - the basis of approximation, {0,1,2,3}=>{'J0','J1','Dini series','linear'}
%           'overSampling'  - the oversampling ratio, default 2
%   (3) microscope parameters
%           'NA'            - numerical aperture of the microscope
%           'lambda'        - Emission wavelength in vacuum
%           'M'             - magnification factor
%           'ns'            - specimen refractive index
%           'ng0'           - coverslip refractive index, design value
%           'ng'            - coverslip refractive index, experimental
%           'ni0'           - immersion refractive index, design
%           'ni'            - immersion refractive index, experimental
%           'ti0'           - working distance of the objective, design
%           'tg0'           - coverslip thickness, design value
%           'tg'            - coverslip thickness, experimental value
%           'resLateral'    - lateral pixel size
%           'resAxial'      - axial pixel size
%           'pZ'            - position of particle
%
%   Reference:
%       [1] Gibson, S.F. & Lanni, F., 1992.
%           Experimental test of an analytical model of aberration in an
%           oil-immersion objective lens used in three-dimensional light
%           microscopy. JOSA A, 9(1), pp.154?166.
%
%   See also AUX_BESSEL, AUX_SHOWPSF

%   Copyright © Jizhou Li, 2016, The Chinese University of Hong Kong
%   Update date: 28 Aug, 2016

warning off;
if ~isfield(params,'size')
    error('Please set the size of PSF model');
end

size = params.size;
params.nx = size(1);
params.ny = size(2);
params.nz = size(3);

%% default parameters
if ~isfield(params,'numBasis')
    params.numBasis = floor(params.nx/2);
end
if ~isfield(params,'numSamp')
    params.numSamp = params.numBasis * 10;
end
if ~isfield(params,'fastcom')
    params.fastcom = 0;
end
if ~isfield(params,'basis')
    params.basis = 3;
end
if ~isfield(params,'overSampling')
    params.overSampling = 2;
end
if ~isfield(params,'NA')
    params.NA = 1.4;
end
if ~isfield(params,'lambda')
    params.lambda = 610e-9;
end
if ~isfield(params,'M')
    params.M = 100;
end
if ~isfield(params,'ns')
    params.ns = 1.33;
end
if ~isfield(params,'ng0')
    params.ng0 = 1.5;
end
if ~isfield(params,'ng')
    params.ng = 1.5;
end
if ~isfield(params,'ni0')
    params.ni0 = 1.5;
end
if ~isfield(params,'ni')
    params.ni = 1.5;
end
if ~isfield(params,'ti0')
    params.ti0 = 150e-6;
end
if ~isfield(params,'tg0')
    params.tg0 = 170e-6;
end
if ~isfield(params,'tg')
    params.tg = 170e-6;
end
if ~isfield(params,'resLateral')
    params.resLateral = 100e-9;
end
if ~isfield(params,'resAxial')
    params.resAxial = 250e-9;
end
if ~isfield(params,'pZ')
    params.pZ = 2000e-9;
end

x0 = (params.nx-1)/2;
y0 = (params.ny-1)/2;
xp = x0; yp=y0;
maxRadius = round(sqrt((params.nx - x0).^2 + (params.ny - y0).^2)) + 1;
R = [0:params.overSampling*maxRadius-1]./params.overSampling;
[X,Y] = meshgrid(0:params.nx-1,0:params.ny-1);
rPixel = sqrt((X-xp).^2 + (Y-yp).^2);
index = floor(rPixel*params.overSampling);
disR = (rPixel - R(index+1))*params.overSampling;

Ti = params.ti0 + params.resAxial*([0:params.nz-1] - ((params.nz - 1.0) / 2.0));

for zi = 0:params.nz-1
    params.ti = Ti(zi+1);
    % the profile of one direction, taking use of the symmetric property
    h = elePSF(params,R*params.resLateral);
    slice = h(index+1) + (h(index + 2) - h(index+1)).* disR;
    PSF(:,:,zi+1) = slice;
end

PSF = PSF./max(PSF(:));

end

function Integral = elePSF(params,r)
%ELEPSF compute the psf profile for 1d signal
%   Integral = ELEPSF(params,r) the psf profile in one direction

%% generate zeros of J0 and J1
% code to generate this:
%   (1) J0
%       J0=@(x)besselj(0,x); N=500;z=zeros(1,N); for n = 1:N,z(n) = fzero(J0,-3*pi/4+n*pi+[-pi/4,pi/4]);end
%   (2) J1
%       J1=@(x)besselj(1,x); N=500;z=zeros(1,N); for n = 1:N,z(n) = fzero(J1,-3*pi/4+n*pi+[-pi/4,pi/4]);end
%   (3) Dini series
%       J1=@(x)0.2*besselj(0,x)-x*besselj(1,x); N=500;z=zeros(1,N); for n = 1:N,z(n) = fzero(J1,-3*pi/4+n*pi+[-pi/4,pi/4]);end
bessel0zeros = [2.40482555769577,5.52007811028631,8.65372791291101,11.7915344390143,14.9309177084878,18.0710639679109,21.2116366298793,24.3524715307493,27.4934791320403,30.6346064684320,33.7758202135736,36.9170983536640,40.0584257646282,43.1997917131767,46.3411883716618,49.4826098973978,52.6240518411150,55.7655107550200,58.9069839260809,62.0484691902272,65.1899648002069,68.3314693298568,71.4729816035937,74.6145006437018,77.7560256303881,80.8975558711376,84.0390907769382,87.1806298436412,90.3221726372105,93.4637187819448,96.6052679509963,99.7468198586806,102.888374254195,106.029930916452,109.171489649805,112.313050280495,115.454612653667,118.596176630873,121.737742087951,124.879308913233,128.020877006008,131.162446275214,134.304016638305,137.445588020284,140.587160352854,143.728733573690,146.870307625797,150.011882456955,153.153458019228,156.295034268534,159.436611164263,162.578188668947,165.719766747955,168.861345369236,172.002924503078,175.144504121903,178.286084200074,181.427664713731,184.569245640639,187.710826960049,190.852408652582,193.993990700109,197.135573085661,200.277155793332,203.418738808199,206.560322116244,209.701905704294,212.843489559950,215.985073671534,219.126658028041,222.268242619084,225.409827434859,228.551412466099,231.692997704039,234.834583140383,237.976168767276,241.117754577268,244.259340563296,247.400926718653,250.542513036970,253.684099512193,256.825686138564,259.967272910605,263.108859823096,266.250446871066,269.392034049776,272.533621354705,275.675208781537,278.816796326153,281.958383984615,285.099971753160,288.241559628188,291.383147606255,294.524735684065,297.666323858459,300.807912126411,303.949500485021,307.091088931505,310.232677463195,313.374266077528,316.515854772043,319.657443544376,322.799032392256,325.940621313497,329.082210305999,332.223799367740,335.365388496774,338.506977691229,341.648566949298,344.790156269244,347.931745649390,351.073335088121,354.214924583876,357.356514135154,360.498103740501,363.639693398517,366.781283107848,369.922872867188,373.064462675271,376.206052530879,379.347642432829,382.489232379979,385.630822371226,388.772412405501,391.914002481767,395.055592599025,398.197182756303,401.338772952662,404.480363187190,407.621953459007,410.763543767255,413.905134111106,417.046724489755,420.188314902422,423.329905348348,426.471495826800,429.613086337063,432.754676878445,435.896267450272,439.037858051892,442.179448682670,445.321039341988,448.462630029246,451.604220743862,454.745811485268,457.887402252913,461.028993046260,464.170583864789,467.312174707990,470.453765575370,473.595356466447,476.736947380753,479.878538317832,483.020129277240,486.161720258543,489.303311261319,492.444902285159,495.586493329661,498.728084394435,501.869675479099,505.011266583284,508.152857706627,511.294448848774,514.436040009382,517.577631188113,520.719222384641,523.860813598645,527.002404829812,530.143996077837,533.285587342422,536.427178623277,539.568769920117,542.710361232665,545.851952560648,548.993543903804,552.135135261871,555.276726634598,558.418318021737,561.559909423046,564.701500838288,567.843092267233,570.984683709653,574.126275165329,577.267866634042,580.409458115583,583.551049609743,586.692641116320,589.834232635116,592.975824165935,596.117415708589,599.259007262891,602.400598828659,605.542190405714,608.683781993881,611.825373592990,614.966965202873,618.108556823365,621.250148454305,624.391740095537,627.533331746904,630.674923408256,633.816515079445,636.958106760324,640.099698450751,643.241290150587,646.382881859693,649.524473577936,652.666065305183,655.807657041305,658.949248786176,662.090840539670,665.232432301666,668.374024072043,671.515615850684,674.657207637474,677.798799432298,680.940391235047,684.081983045611,687.223574863882,690.365166689756,693.506758523129,696.648350363899,699.789942211967,702.931534067236,706.073125929609,709.214717798991,712.356309675290,715.497901558415,718.639493448276,721.781085344786,724.922677247857,728.064269157406,731.205861073348,734.347452995601,737.489044924085,740.630636858720,743.772228799429,746.913820746135,750.055412698762,753.197004657237,756.338596621487,759.480188591439,762.621780567024,765.763372548171,768.904964534814,772.046556526885,775.188148524317,778.329740527046,781.471332535009,784.612924548141,787.754516566382,790.896108589670,794.037700617946,797.179292651150,800.320884689225,803.462476732114,806.604068779759,809.745660832106,812.887252889101,816.028844950689,819.170437016818,822.312029087435,825.453621162490,828.595213241932,831.736805325711,834.878397413779,838.019989506087,841.161581602587,844.303173703233,847.444765807978,850.586357916778,853.727950029588,856.869542146362,860.011134267059,863.152726391635,866.294318520048,869.435910652255,872.577502788218,875.719094927894,878.860687071244,882.002279218229,885.143871368811,888.285463522950,891.427055680609,894.568647841752,897.710240006342,900.851832174342,903.993424345717,907.135016520432,910.276608698453,913.418200879745,916.559793064274,919.701385252009,922.842977442914,925.984569636960,929.126161834113,932.267754034342,935.409346237617,938.550938443906,941.692530653180,944.834122865408,947.975715080562,951.117307298612,954.258899519530,957.400491743287,960.542083969856,963.683676199209,966.825268431319,969.966860666160,973.108452903704,976.250045143926,979.391637386799,982.533229632300,985.674821880401,988.816414131079,991.958006384309,995.099598640068,998.241190898330,1001.38278315907,1004.52437542227,1007.66596768791,1010.80755995595,1013.94915222639,1017.09074449919,1020.23233677434,1023.37392905181,1026.51552133158,1029.65711361363,1032.79870589795,1035.94029818450,1039.08189047327,1042.22348276425,1045.36507505740,1048.50666735271,1051.64825965016,1054.78985194974,1057.93144425141,1061.07303655517,1064.21462886100,1067.35622116887,1070.49781347877,1073.63940579069,1076.78099810459,1079.92259042048,1083.06418273832,1086.20577505810,1089.34736737981,1092.48895970343,1095.63055202894,1098.77214435633,1101.91373668558,1105.05532901667,1108.19692134959,1111.33851368432,1114.48010602085,1117.62169835917,1120.76329069925,1123.90488304108,1127.04647538465,1130.18806772994,1133.32966007695,1136.47125242565,1139.61284477603,1142.75443712807,1145.89602948177,1149.03762183711,1152.17921419408,1155.32080655266,1158.46239891284,1161.60399127461,1164.74558363795,1167.88717600285,1171.02876836930,1174.17036073729,1177.31195310680,1180.45354547783,1183.59513785035,1186.73673022437,1189.87832259985,1193.01991497681,1196.16150735521,1199.30309973506,1202.44469211634,1205.58628449904,1208.72787688315,1211.86946926865,1215.01106165554,1218.15265404380,1221.29424643343,1224.43583882442,1227.57743121675,1230.71902361041,1233.86061600540,1237.00220840170,1240.14380079930,1243.28539319820,1246.42698559838,1249.56857799983,1252.71017040255,1255.85176280653,1258.99335521175,1262.13494761821,1265.27654002589,1268.41813243479,1271.55972484490,1274.70131725622,1277.84290966872,1280.98450208240,1284.12609449726,1287.26768691329,1290.40927933047,1293.55087174880,1296.69246416827,1299.83405658887,1302.97564901059,1306.11724143343,1309.25883385738,1312.40042628243,1315.54201870857,1318.68361113579,1321.82520356409,1324.96679599345,1328.10838842388,1331.24998085536,1334.39157328789,1337.53316572145,1340.67475815605,1343.81635059167,1346.95794302831,1350.09953546595,1353.24112790460,1356.38272034425,1359.52431278488,1362.66590522650,1365.80749766909,1368.94909011265,1372.09068255717,1375.23227500264,1378.37386744907,1381.51545989644,1384.65705234474,1387.79864479397,1390.94023724413,1394.08182969520,1397.22342214718,1400.36501460007,1403.50660705385,1406.64819950853,1409.78979196410,1412.93138442054,1416.07297687786,1419.21456933605,1422.35616179510,1425.49775425501,1428.63934671578,1431.78093917738,1434.92253163983,1438.06412410312,1441.20571656723,1444.34730903217,1447.48890149792,1450.63049396449,1453.77208643187,1456.91367890005,1460.05527136903,1463.19686383880,1466.33845630936,1469.48004878071,1472.62164125283,1475.76323372572,1478.90482619938,1482.04641867380,1485.18801114898,1488.32960362492,1491.47119610160,1494.61278857903,1497.75438105719,1500.89597353609,1504.03756601572,1507.17915849608,1510.32075097715,1513.46234345894,1516.60393594145,1519.74552842466,1522.88712090857,1526.02871339318,1529.17030587849,1532.31189836449,1535.45349085117,1538.59508333853,1541.73667582657,1544.87826831529,1548.01986080467,1551.16145329472,1554.30304578543,1557.44463827680,1560.58623076882,1563.72782326149,1566.86941575480,1570.01100824875];
bessel1zeros = [3.83170597020751,7.01558666981562,10.1734681350627,13.3236919363142,16.4706300508776,19.6158585104682,22.7600843805928,25.9036720876184,29.0468285349169,32.1896799109744,35.3323075500839,38.4747662347716,41.6170942128145,44.7593189976528,47.9014608871855,51.0435351835715,54.1855536410613,57.3275254379010,60.4694578453475,63.6113566984812,66.7532267340985,69.8950718374958,73.0368952255738,76.1786995846415,79.3204871754763,82.4622599143736,85.6040194363502,88.7457671449263,91.8875042516950,95.0292318080447,98.1709507307908,101.312661823039,104.454365791283,107.596063259509,110.737754780899,113.879440847595,117.021121898892,120.162798328149,123.304470488636,126.446138698517,129.587803245104,132.729464388510,135.871122364789,139.012777388660,142.154429655859,145.296079345196,148.437726620342,151.579371631401,154.721014516286,157.862655401930,161.004294405362,164.145931634650,167.287567189744,170.429201163227,173.570833640976,176.712464702764,179.854094422788,182.995722870153,186.137350109296,189.278976200376,192.420601199626,195.562225159663,198.703848129777,201.845470156191,204.987091282292,208.128711548850,211.270330994208,214.411949654462,217.553567563624,220.695184753769,223.836801255172,226.978417096429,230.120032304579,233.261646905201,236.403260922514,239.544874379470,242.686487297829,245.828099698240,248.969711600310,252.111323022669,255.252933983028,258.394544498240,261.536154584344,264.677764256622,267.819373529635,270.960982417271,274.102590932781,277.244199088815,280.385806897456,283.527414370251,286.669021518243,289.810628351994,292.952234881614,296.093841116782,299.235447066774,302.377052740478,305.518658146416,308.660263292764,311.801868187371,314.943472837767,318.085077251190,321.226681434593,324.368285394658,327.509889137813,330.651492670239,333.793095997889,336.934699126488,340.076302061554,343.217904808401,346.359507372151,349.501109757741,352.642711969932,355.784314013319,358.925915892333,362.067517611253,365.209119174210,368.350720585196,371.492321848065,374.633922966544,377.775523944235,380.917124784621,384.058725491072,387.200326066848,390.341926515104,393.483526838895,396.625127041178,399.766727124817,402.908327092588,406.049926947180,409.191526691201,412.333126327177,415.474725857559,418.616325284726,421.757924610982,424.899523838567,428.041122969653,431.182722006349,434.324320950704,437.465919804707,440.607518570290,443.749117249332,446.890715843658,450.032314355042,453.173912785208,456.315511135835,459.457109408554,462.598707604951,465.740305726573,468.881903774921,472.023501751458,475.165099657610,478.306697494762,481.448295264266,484.589892967438,487.731490605558,490.873088179877,494.014685691610,497.156283141946,500.297880532039,503.439477863019,506.581075135985,509.722672352010,512.864269512139,516.005866617394,519.147463668772,522.289060667243,525.430657613758,528.572254509243,531.713851354602,534.855448150718,537.997044898455,541.138641598654,544.280238252139,547.421834859715,550.563431422166,553.705027940262,556.846624414753,559.988220846372,563.129817235838,566.271413583851,569.413009891099,572.554606158251,575.696202385965,578.837798574883,581.979394725632,585.120990838828,588.262586915072,591.404182954953,594.545778959048,597.687374927921,600.828970862124,603.970566762199,607.112162628675,610.253758462071,613.395354262895,616.536950031646,619.678545768810,622.820141474867,625.961737150284,629.103332795521,632.244928411027,635.386523997244,638.528119554603,641.669715083528,644.811310584436,647.952906057734,651.094501503820,654.236096923088,657.377692315922,660.519287682699,663.660883023789,666.802478339555,669.944073630353,673.085668896533,676.227264138439,679.368859356406,682.510454550766,685.652049721842,688.793644869954,691.935239995414,695.076835098530,698.218430179603,701.360025238929,704.501620276799,707.643215293499,710.784810289309,713.926405264506,717.068000219361,720.209595154139,723.351190069102,726.492784964507,729.634379840607,732.775974697650,735.917569535881,739.059164355538,742.200759156858,745.342353940074,748.483948705411,751.625543453096,754.767138183349,757.908732896385,761.050327592419,764.191922271660,767.333516934314,770.475111580584,773.616706210670,776.758300824768,779.899895423072,783.041490005771,786.183084573053,789.324679125101,792.466273662097,795.607868184219,798.749462691643,801.891057184541,805.032651663084,808.174246127438,811.315840577769,814.457435014239,817.599029437008,820.740623846233,823.882218242069,827.023812624668,830.165406994182,833.307001350756,836.448595694539,839.590190025673,842.731784344300,845.873378650558,849.014972944586,852.156567226519,855.298161496489,858.439755754629,861.581350001067,864.722944235932,867.864538459348,871.006132671440,874.147726872330,877.289321062138,880.430915240983,883.572509408982,886.714103566249,889.855697712900,892.997291849045,896.138885974795,899.280480090260,902.422074195546,905.563668290759,908.705262376005,911.846856451386,914.988450517003,918.130044572957,921.271638619347,924.413232656270,927.554826683822,930.696420702099,933.838014711193,936.979608711198,940.121202702205,943.262796684302,946.404390657580,949.545984622125,952.687578578025,955.829172525363,958.970766464225,962.112360394693,965.253954316849,968.395548230775,971.537142136550,974.678736034253,977.820329923961,980.961923805752,984.103517679701,987.245111545884,990.386705404374,993.528299255243,996.669893098565,999.811486934410,1002.95308076285,1006.09467458395,1009.23626839778,1012.37786220442,1015.51945600391,1018.66104979634,1021.80264358177,1024.94423736026,1028.08583113187,1031.22742489668,1034.36901865473,1037.51061240609,1040.65220615083,1043.79379988899,1046.93539362065,1050.07698734586,1053.21858106467,1056.36017477715,1059.50176848335,1062.64336218332,1065.78495587713,1068.92654956482,1072.06814324645,1075.20973692208,1078.35133059174,1081.49292425551,1084.63451791342,1087.77611156554,1090.91770521190,1094.05929885256,1097.20089248756,1100.34248611697,1103.48407974081,1106.62567335915,1109.76726697203,1112.90886057949,1116.05045418158,1119.19204777834,1122.33364136983,1125.47523495608,1128.61682853713,1131.75842211304,1134.90001568384,1138.04160924958,1141.18320281029,1144.32479636603,1147.46638991682,1150.60798346272,1153.74957700375,1156.89117053997,1160.03276407141,1163.17435759810,1166.31595112009,1169.45754463741,1172.59913815011,1175.74073165821,1178.88232516176,1182.02391866080,1185.16551215535,1188.30710564545,1191.44869913114,1194.59029261246,1197.73188608943,1200.87347956210,1204.01507303049,1207.15666649464,1210.29825995458,1213.43985341035,1216.58144686197,1219.72304030948,1222.86463375292,1226.00622719230,1229.14782062767,1232.28941405905,1235.43100748648,1238.57260090998,1241.71419432959,1244.85578774533,1247.99738115723,1251.13897456532,1254.28056796964,1257.42216137020,1260.56375476704,1263.70534816019,1266.84694154966,1269.98853493550,1273.13012831772,1276.27172169635,1279.41331507143,1282.55490844297,1285.69650181100,1288.83809517555,1291.97968853664,1295.12128189430,1298.26287524855,1301.40446859941,1304.54606194692,1307.68765529110,1310.82924863196,1313.97084196954,1317.11243530386,1320.25402863493,1323.39562196279,1326.53721528746,1329.67880860895,1332.82040192730,1335.96199524252,1339.10358855464,1342.24518186367,1345.38677516964,1348.52836847257,1351.66996177249,1354.81155506940,1357.95314836334,1361.09474165433,1364.23633494237,1367.37792822751,1370.51952150974,1373.66111478910,1376.80270806561,1379.94430133928,1383.08589461013,1386.22748787819,1389.36908114346,1392.51067440598,1395.65226766576,1398.79386092281,1401.93545417715,1405.07704742882,1408.21864067781,1411.36023392415,1414.50182716786,1417.64342040895,1420.78501364745,1423.92660688336,1427.06820011671,1430.20979334751,1433.35138657579,1436.49297980155,1439.63457302481,1442.77616624559,1445.91775946391,1449.05935267977,1452.20094589321,1455.34253910423,1458.48413231284,1461.62572551908,1464.76731872294,1467.90891192444,1471.05050512360,1474.19209832044,1477.33369151497,1480.47528470721,1483.61687789716,1486.75847108484,1489.90006427028,1493.04165745347,1496.18325063444,1499.32484381320,1502.46643698977,1505.60803016415,1508.74962333636,1511.89121650642,1515.03280967433,1518.17440284012,1521.31599600379,1524.45758916536,1527.59918232484,1530.74077548224,1533.88236863758,1537.02396179087,1540.16555494212,1543.30714809135,1546.44874123856,1549.59033438377,1552.73192752698,1555.87352066823,1559.01511380750,1562.15670694483,1565.29830008021,1568.43989321366,1571.58148634519];
diniseries = [0.616974766101560,3.88350553129723,7.04402929220661,10.1931056369408,13.3386932202932,16.4827678087316,19.6260513413601,22.7688697726206,25.9113916970579,29.0537130435692,32.1958924029986,35.3379675779832,38.4799640490770,41.6218996159417,44.7637870881355,47.9056359189870,51.0474532370593,54.1892445192960,57.3310140431034,60.4727651976641,63.6145007030903,66.7562227677477,69.8979332031861,73.0396335094290,76.1813249391744,79.3230085467469,82.4646852258676,85.6063557391112,88.7480207411091,91.8896807969950,95.0313363971934,98.1729879693695,101.314635888157,104.456280483130,107.597922045380,110.739560832973,113.881197075503,117.022830977916,120.164462723727,123.306092477753,126.447720388431,129.589346589811,132.730971203250,135.872594338883,139.014216096891,142.155836568601,145.297455837440,148.439073979776,151.580691065645,154.722307159394,157.863922320252,161.005536602822,164.147150057530,167.288762731011,170.430374666466,173.571985903965,176.713596480731,179.855206431386,182.996815788173,186.138424581161,189.280032838421,192.421640586191,195.563247849025,198.704854649922,201.846461010449,204.988066950854,208.129672490160,211.271277646259,214.412882435994,217.554486875237,220.696090978954,223.837694761273,226.979298235538,230.120901414365,233.262504309691,236.404106932817,239.545709294454,242.687311404755,245.828913273357,248.970514909407,252.112116321601,255.253717518202,258.395318507075,261.536919295705,264.678519891221,267.820120300420,270.961720529782,274.103320585491,277.244920473449,280.386520199295,283.528119768417,286.669719185969,289.811318456879,292.952917585864,296.094516577443,299.236115435942,302.377714165511,305.519312770125,308.660911253600,311.802509619598,314.944107871634,318.085706013085,321.227304047196,324.368901977085,327.510499805751,330.652097536079,333.793695170846,336.935292712725,340.076890164291,343.218487528023,346.360084806311,349.501682001459,352.643279115689,355.784876151145,358.926473109895,362.068069993936,365.209666805196,368.351263545537,371.492860216758,374.634456820598,377.776053358737,380.917649832803,384.059246244366,387.200842594948,390.342438886022,393.484035119013,396.625631295301,399.767227416223,402.908823483074,406.050419497109,409.192015459544,412.333611371560,415.475207234298,418.616803048870,421.758398816352,424.899994537787,428.041590214190,431.183185846544,434.324781435807,437.466376982906,440.607972488743,443.749567954195,446.891163380112,450.032758767324,453.174354116635,456.315949428828,459.457544704664,462.599139944884,465.740735150209,468.882330321339,472.023925458959,475.165520563732,478.307115636306,481.448710677311,484.590305687361,487.731900667054,490.873495616973,494.015090537687,497.156685429748,500.298280293696,503.439875130058,506.581469939347,509.723064722064,512.864659478697,516.006254209722,519.147848915604,522.289443596797,525.431038253744,528.572632886877,531.714227496618,534.855822083379,537.997416647563,541.139011189563,544.280605709764,547.422200208540,550.563794686259,553.705389143278,556.846983579949,559.988577996613,563.130172393605,566.271766771253,569.413361129877,572.554955469791,575.696549791299,578.838144094703,581.979738380295,585.121332648363,588.262926899186,591.404521133040,594.546115350194,597.687709550911,600.829303735449,603.970897904061,607.112492056993,610.254086194488,613.395680316782,616.537274424110,619.678868516697,622.820462594767,625.962056658539,629.103650708227,632.245244744040,635.386838766185,638.528432774864,641.670026770273,644.811620752608,647.953214722058,651.094808678809,654.236402623046,657.377996554946,660.519590474687,663.661184382440,666.802778278376,669.944372162660,673.085966035455,676.227559896923,679.369153747219,682.510747586499,685.652341414913,688.793935232610,691.935529039737,695.077122836436,698.218716622849,701.360310399113,704.501904165364,707.643497921736,710.785091668360,713.926685405364,717.068279132875,720.209872851017,723.351466559912,726.493060259680,729.634653950439,732.776247632305,735.917841305392,739.059434969811,742.201028625673,745.342622273086,748.484215912156,751.625809542989,754.767403165686,757.908996780349,761.050590387077,764.192183985969,767.333777577120,770.475371160626,773.616964736579,776.758558305071,779.900151866192,783.041745420031,786.183338966676,789.324932506211,792.466526038722,795.608119564293,798.749713083003,801.891306594936,805.032900100169,808.174493598780,811.316087090848,814.457680576447,817.599274055653,820.740867528537,823.882460995174,827.024054455633,830.165647909986,833.307241358301,836.448834800646,839.590428237089,842.732021667695,845.873615092529,849.015208511655,852.156801925137,855.298395333037,858.439988735415,861.581582132333,864.723175523850,867.864768910025,871.006362290914,874.147955666576,877.289549037067,880.431142402442,883.572735762754,886.714329118060,889.855922468410,892.997515813858,896.139109154455,899.280702490252,902.422295821299,905.563889147646,908.705482469341,911.847075786432,914.988669098967,918.130262406993,921.271855710555,924.413449009699,927.555042304471,930.696635594914,933.838228881072,936.979822162988,940.121415440705,943.263008714264,946.404601983707,949.546195249076,952.687788510409,955.829381767747,958.970975021130,962.112568270596,965.254161516183,968.395754757928,971.537347995871,974.678941230046,977.820534460490,980.962127687240,984.103720910330,987.245314129796,990.386907345672,993.528500557991,996.670093766789,999.811686972097,1002.95328017395,1006.09487337238,1009.23646656741,1012.37805975909,1015.51965294744,1018.66124613248,1021.80283931426,1024.94443249281,1028.08602566814,1031.22761884029,1034.36921200930,1037.51080517518,1040.65239833797,1043.79399149770,1046.93558465439,1050.07717780806,1053.21877095876,1056.36036410649,1059.50195725130,1062.64355039320,1065.78514353223,1068.92673666840,1072.06832980174,1075.20992293228,1078.35151606004,1081.49310918504,1084.63470230732,1087.77629542688,1090.91788854376,1094.05948165799,1097.20107476957,1100.34266787854,1103.48426098492,1106.62585408872,1109.76744718998,1112.90904028871,1116.05063338493,1119.19222647867,1122.33381956994,1125.47541265877,1128.61700574518,1131.75859882918,1134.90019191080,1138.04178499006,1141.18337806698,1144.32497114157,1147.46656421385,1150.60815728385,1153.74975035158,1156.89134341706,1160.03293648031,1163.17452954135,1166.31612260019,1169.45771565686,1172.59930871137,1175.74090176373,1178.88249481397,1182.02408786210,1185.16568090813,1188.30727395210,1191.44886699400,1194.59046003386,1197.73205307170,1200.87364610752,1204.01523914135,1207.15683217320,1210.29842520309,1213.44001823103,1216.58161125703,1219.72320428112,1222.86479730330,1226.00639032360,1229.14798334202,1232.28957635858,1235.43116937329,1238.57276238617,1241.71435539724,1244.85594840650,1247.99754141396,1251.13913441966,1254.28072742358,1257.42232042576,1260.56391342620,1263.70550642492,1266.84709942192,1269.98869241722,1273.13028541084,1276.27187840279,1279.41347139307,1282.55506438170,1285.69665736870,1288.83825035407,1291.97984333782,1295.12143631998,1298.26302930054,1301.40462227953,1304.54621525695,1307.68780823281,1310.82940120713,1313.97099417991,1317.11258715117,1320.25418012092,1323.39577308917,1326.53736605593,1329.67895902121,1332.82055198502,1335.96214494737,1339.10373790827,1342.24533086773,1345.38692382577,1348.52851678238,1351.67010973759,1354.81170269140,1357.95329564382,1361.09488859486,1364.23648154453,1367.37807449284,1370.51966743980,1373.66126038541,1376.80285332970,1379.94444627266,1383.08603921430,1386.22763215464,1389.36922509369,1392.51081803144,1395.65241096792,1398.79400390312,1401.93559683707,1405.07718976976,1408.21878270120,1411.36037563141,1414.50196856039,1417.64356148814,1420.78515441469,1423.92674734003,1427.06834026417,1430.20993318713,1433.35152610891,1436.49311902951,1439.63471194894,1442.77630486722,1445.91789778435,1449.05949070034,1452.20108361519,1455.34267652891,1458.48426944151,1461.62586235300,1464.76745526339,1467.90904817267,1471.05064108086,1474.19223398797,1477.33382689399,1480.47541979895,1483.61701270284,1486.75860560568,1489.90019850746,1493.04179140820,1496.18338430790,1499.32497720657,1502.46657010421,1505.60816300084,1508.74975589645,1511.89134879106,1515.03294168467,1518.17453457728,1521.31612746891,1524.45772035956,1527.59931324923,1530.74090613793,1533.88249902567,1537.02409191246,1540.16568479829,1543.30727768317,1546.44887056712,1549.59046345013,1552.73205633221,1555.87364921337,1559.01524209362,1562.15683497295,1565.29842785138,1568.44002072890];

a = 0;
b = min(1, params.ns/params.NA);

L = params.numSamp;
fastcom = params.fastcom;

Rho0 = linspace(a,b,L);
Rho = Rho0;

NN = params.numBasis;
k0 = 2*pi/params.lambda;

W = funOPD(params,Rho,k0);
Ffun = cos(W) + 1i*sin(W);

switch params.basis
    case 0 % J0
        an = bessel0zeros(1:NN);
        anRho = bsxfun(@times,an,Rho');
    case 1 % J1
        an = bessel1zeros(1:NN);
        anRho = bsxfun(@times,an,Rho');
    case 2 % Dini series
        an = diniseries(1:NN);
        anRho = bsxfun(@times,an,Rho');
    case 3 % linear, 3m-2
        an = 3*([1:NN])-2;
        anRho = bsxfun(@times,an,Rho');
    otherwise
        error('Not supported yet!');
end

J = funBessel0(fastcom, anRho);

A = k0*params.NA*r;
A2 = A.^2;

Ci = J\Ffun';
% Ci = pinv(J)*Ffun';

Ab = A.*b;

J0A = funBessel0(fastcom, Ab);
J1A = A.*funBessel1(fastcom, Ab);

anJ0A = bsxfun(@times,J0A,an');
anb = an.*b;
an2 = an.^2;
B1anb = funBessel1(fastcom, anb);
B0anb = funBessel0(fastcom, anb);

Ele = bsxfun(@times,anJ0A,B1anb') - bsxfun(@times,J1A,B0anb');
domin = bsxfun(@minus, an2', A2);
Ele = Ele.*b./domin;

ciEle = bsxfun(@times,Ele,Ci);

if size(ciEle,1)<=1
    sumE = ciEle;
else
    sumE = sum(ciEle);
end

Integral = abs(sumE).^2;

end


function W = funOPD(params,rho,k0)
%% Computation of optical path difference (OPD) and its phase W

C1 = params.ns*params.pZ;
C2 = params.ni*(params.ti - params.ti0);
C3 = params.ng*(params.tg - params.tg0);

OPDs = C1*sqrt(1-(params.NA*rho/params.ns).^2);
OPDi = C2*sqrt(1-(params.NA*rho/params.ni).^2);
OPDg = C3*sqrt(1-(params.NA*rho/params.ng).^2);

OPD = OPDs + OPDi + OPDg;

W = k0*OPD;
end

function J = funBessel0(fastcom, X)
if(fastcom)
    J = aux_Bessel(0,X);
    J = reshape(J, size(X));
else
    J = besselj(0, X);
end
end

function J = funBessel1(fastcom, X)
if(fastcom)
    J = aux_Bessel(1,X);
    J = reshape(J, size(X));
else
    J = besselj(1, X);
end
end

