function PSF = MicroPSF(params)
%MICROPSF Compute the 3D PSF model described by Gibson and Lanni (JOSA 1992).
%   PSF = MICROPSF(params) return a 3D PSF given parameters
%
%   Parameters include:
%   (1) image properties
%           'size'  -  the size of the 3D PSF, e.g. params.size = [256 256 128];
%   (2) precision control
%           'numBasis'      - the number of approximation basis, default 'size(1)/2'
%           'numSamp'       - the number of sampling to determine the basis coefficients
%           'fastcom'       - fast approximation of Bessel functions, default 0
%           'basis'         - the basis of approximation, {0,1,2}=>{'J0','J1','linear'}
%           'overSampling'  - the oversampling ratio, default 2
%   (3) microscope parameters
%           'NA'            - numerical aperture of the microscope
%           'lambda'        - Emission wavelength in vacuum
%           'M'             - magnification factor
%           'ns'            - specimen refractive index
%           'ng0'           - coverslip refractive index, design value
%           'ng'            - coverslip refractive index, experimental
%           'ni0'           - immersion refractive index, design
%           'ni'            - immersion refractive index, experimental
%           'ti0'           - working distance of the objective, design
%           'tg0'           - coverslip thickness, design value
%           'tg'            - coverslip thickness, experimental value
%           'resLateral'    - lateral pixel size
%           'resAxial'      - axial pixel size
%           'pZ'            - position of particle
%
%   Reference:
%       [1] Gibson, S.F. & Lanni, F., 1992.
%           Experimental test of an analytical model of aberration in an
%           oil-immersion objective lens used in three-dimensional light
%           microscopy. JOSA A, 9(1), pp.154-166.
%
%   See also AUX_BESSEL, AUX_SHOWPSF

%   Copyright © Jizhou Li, 2016, The Chinese University of Hong Kong
%   Update date: 09 Oct, 2016

warning off;
if ~isfield(params,'size')
    error('Please set the size of PSF model');
end

size = params.size;
params.nx = size(1);
params.ny = size(2);
params.nz = size(3);

%% default parameters
if ~isfield(params,'numBasis')
    params.numBasis = floor(params.nx/2);
end
if ~isfield(params,'numSamp')
    params.numSamp = params.numBasis * 10;
end
if ~isfield(params,'fastcom')
    params.fastcom = 0;
end
if ~isfield(params,'basis')
    params.basis = 3;
end
if ~isfield(params,'overSampling')
    params.overSampling = 2;
end
if ~isfield(params,'NA')
    params.NA = 1.4;
end
if ~isfield(params,'lambda')
    params.lambda = 610e-9;
end
if ~isfield(params,'M')
    params.M = 100;
end
if ~isfield(params,'ns')
    params.ns = 1.33;
end
if ~isfield(params,'ng0')
    params.ng0 = 1.5;
end
if ~isfield(params,'ng')
    params.ng = 1.5;
end
if ~isfield(params,'ni0')
    params.ni0 = 1.5;
end
if ~isfield(params,'ni')
    params.ni = 1.5;
end
if ~isfield(params,'ti0')
    params.ti0 = 150e-6;
end
if ~isfield(params,'tg0')
    params.tg0 = 170e-6;
end
if ~isfield(params,'tg')
    params.tg = 170e-6;
end
if ~isfield(params,'resLateral')
    params.resLateral = 100e-9;
end
if ~isfield(params,'resAxial')
    params.resAxial = 250e-9;
end
if ~isfield(params,'pZ')
    params.pZ = 2000e-9;
end


x0 = (params.nx-1)/2;
y0 = (params.ny-1)/2;
xp = x0; yp=y0;
maxRadius = round(sqrt((params.nx - x0).^2 + (params.ny - y0).^2)) + 1;
R = [0:params.overSampling*maxRadius-1]./params.overSampling;
[X,Y] = meshgrid(0:params.nx-1,0:params.ny-1);
rPixel = sqrt((X-xp).^2 + (Y-yp).^2);
index = floor(rPixel*params.overSampling);
disR = (rPixel - R(index+1))*params.overSampling;

Ti = params.ti0 + params.resAxial*([0:params.nz-1] - ((params.nz - 1.0) / 2.0));

a = 0;
b = min(1, params.ns/params.NA);
L = params.numSamp;

Rho = linspace(a,b,L)';


fastcom = params.fastcom;
NN = params.numBasis;
k0 = 2*pi/params.lambda;

%% generate zeros of J0 and J1
% code to generate this:
%   (1) J0
%       J0=@(x)besselj(0,x); N=500;z=zeros(1,N); for n = 1:N,z(n) = fzero(J0,-3*pi/4+n*pi+[-pi/4,pi/4+1]);end
%   (2) J1
%       J1=@(x)besselj(1,x); N=500;z=zeros(1,N); for n = 1:N,z(n) = fzero(J1,-3*pi/4+n*pi+[-pi/4,pi/4]);end
%   (3) linear  2.7*m-2
%   (4) Dini series
%       J1=@(x)0.2*besselj(0,x)-x*besselj(1,x); N=500;z=zeros(1,N); for n = 1:N,z(n) = fzero(J1,-3*pi/4+n*pi+[-pi/4,pi/4]);end

switch params.basis
    case 0 % J0
        bessel0zeros = [2.40482555769577,5.52007811028631,8.65372791291101,11.7915344390143,14.9309177084878,18.0710639679109,21.2116366298793,24.3524715307493,27.4934791320403,30.6346064684320,33.7758202135736,36.9170983536640,40.0584257646282,43.1997917131767,46.3411883716618,49.4826098973978,52.6240518411150,55.7655107550200,58.9069839260809,62.0484691902272,65.1899648002069,68.3314693298568,71.4729816035937,74.6145006437018,77.7560256303881,80.8975558711376,84.0390907769382,87.1806298436412,90.3221726372105,93.4637187819448,96.6052679509963,99.7468198586806,102.888374254195,106.029930916452,109.171489649805,112.313050280495,115.454612653667,118.596176630873,121.737742087951,124.879308913233,128.020877006008,131.162446275214,134.304016638305,137.445588020284,140.587160352854,143.728733573690,146.870307625797,150.011882456955,153.153458019228,156.295034268534,159.436611164263,162.578188668947,165.719766747955,168.861345369236,172.002924503078,175.144504121903,178.286084200074,181.427664713731,184.569245640639,187.710826960049,190.852408652582,193.993990700109,197.135573085661,200.277155793332,203.418738808199,206.560322116244,209.701905704294,212.843489559950,215.985073671534,219.126658028041,222.268242619084,225.409827434859,228.551412466099,231.692997704039,234.834583140383,237.976168767276,241.117754577268,244.259340563296,247.400926718653,250.542513036970,253.684099512193,256.825686138564,259.967272910605,263.108859823096,266.250446871066,269.392034049776,272.533621354705,275.675208781537,278.816796326153,281.958383984615,285.099971753160,288.241559628188,291.383147606255,294.524735684065,297.666323858459,300.807912126411,303.949500485021,307.091088931505,310.232677463195,313.374266077528,316.515854772043,319.657443544376,322.799032392256,325.940621313497,329.082210305999,332.223799367740,335.365388496774,338.506977691229,341.648566949298,344.790156269244,347.931745649390,351.073335088121,354.214924583876,357.356514135154,360.498103740501,363.639693398517,366.781283107848,369.922872867188,373.064462675271,376.206052530879,379.347642432829,382.489232379979,385.630822371226,388.772412405501,391.914002481767,395.055592599025,398.197182756303,401.338772952662,404.480363187190,407.621953459007,410.763543767255,413.905134111106,417.046724489755,420.188314902422,423.329905348348,426.471495826800,429.613086337063,432.754676878445,435.896267450272,439.037858051892,442.179448682670,445.321039341988,448.462630029246,451.604220743862,454.745811485268,457.887402252913,461.028993046260,464.170583864789,467.312174707990,470.453765575370,473.595356466447,476.736947380753,479.878538317832,483.020129277240,486.161720258543,489.303311261319,492.444902285159,495.586493329661,498.728084394435,501.869675479099,505.011266583284,508.152857706627,511.294448848774,514.436040009382,517.577631188113,520.719222384641,523.860813598645,527.002404829812,530.143996077837,533.285587342422,536.427178623277,539.568769920117,542.710361232665,545.851952560648,548.993543903804,552.135135261871,555.276726634598,558.418318021737,561.559909423046,564.701500838288,567.843092267233,570.984683709653,574.126275165329,577.267866634042,580.409458115583,583.551049609743,586.692641116320,589.834232635116,592.975824165935,596.117415708589,599.259007262891,602.400598828659,605.542190405714,608.683781993881,611.825373592990,614.966965202873,618.108556823365,621.250148454305,624.391740095537,627.533331746904,630.674923408256,633.816515079445,636.958106760324,640.099698450751,643.241290150587,646.382881859693,649.524473577936,652.666065305183,655.807657041305,658.949248786176,662.090840539670,665.232432301666,668.374024072043,671.515615850684,674.657207637474,677.798799432298,680.940391235047,684.081983045611,687.223574863882,690.365166689756,693.506758523129,696.648350363899,699.789942211967,702.931534067236,706.073125929609,709.214717798991,712.356309675290,715.497901558415,718.639493448276,721.781085344786,724.922677247857,728.064269157406,731.205861073348,734.347452995601,737.489044924085,740.630636858720,743.772228799429,746.913820746135,750.055412698762,753.197004657237,756.338596621487,759.480188591439,762.621780567024,765.763372548171,768.904964534814,772.046556526885,775.188148524317,778.329740527046,781.471332535009,784.612924548141,787.754516566382,790.896108589670,794.037700617946,797.179292651150,800.320884689225,803.462476732114,806.604068779759,809.745660832106,812.887252889101,816.028844950689,819.170437016818,822.312029087435,825.453621162490,828.595213241932,831.736805325711,834.878397413779,838.019989506087,841.161581602587,844.303173703233,847.444765807978,850.586357916778,853.727950029588,856.869542146362,860.011134267059,863.152726391635,866.294318520048,869.435910652255,872.577502788218,875.719094927894,878.860687071244,882.002279218229,885.143871368811,888.285463522950,891.427055680609,894.568647841752,897.710240006342,900.851832174342,903.993424345717,907.135016520432,910.276608698453,913.418200879745,916.559793064274,919.701385252009,922.842977442914,925.984569636960,929.126161834113,932.267754034342,935.409346237617,938.550938443906,941.692530653180,944.834122865408,947.975715080562,951.117307298612,954.258899519530,957.400491743287,960.542083969856,963.683676199209,966.825268431319,969.966860666160,973.108452903704,976.250045143926,979.391637386799,982.533229632300,985.674821880401,988.816414131079,991.958006384309,995.099598640068,998.241190898330,1001.38278315907,1004.52437542227,1007.66596768791,1010.80755995595,1013.94915222639,1017.09074449919,1020.23233677434,1023.37392905181,1026.51552133158,1029.65711361363,1032.79870589795,1035.94029818450,1039.08189047327,1042.22348276425,1045.36507505740,1048.50666735271,1051.64825965016,1054.78985194974,1057.93144425141,1061.07303655517,1064.21462886100,1067.35622116887,1070.49781347877,1073.63940579069,1076.78099810459,1079.92259042048,1083.06418273832,1086.20577505810,1089.34736737981,1092.48895970343,1095.63055202894,1098.77214435633,1101.91373668558,1105.05532901667,1108.19692134959,1111.33851368432,1114.48010602085,1117.62169835917,1120.76329069925,1123.90488304108,1127.04647538465,1130.18806772994,1133.32966007695,1136.47125242565,1139.61284477603,1142.75443712807,1145.89602948177,1149.03762183711,1152.17921419408,1155.32080655266,1158.46239891284,1161.60399127461,1164.74558363795,1167.88717600285,1171.02876836930,1174.17036073729,1177.31195310680,1180.45354547783,1183.59513785035,1186.73673022437,1189.87832259985,1193.01991497681,1196.16150735521,1199.30309973506,1202.44469211634,1205.58628449904,1208.72787688315,1211.86946926865,1215.01106165554,1218.15265404380,1221.29424643343,1224.43583882442,1227.57743121675,1230.71902361041,1233.86061600540,1237.00220840170,1240.14380079930,1243.28539319820,1246.42698559838,1249.56857799983,1252.71017040255,1255.85176280653,1258.99335521175,1262.13494761821,1265.27654002589,1268.41813243479,1271.55972484490,1274.70131725622,1277.84290966872,1280.98450208240,1284.12609449726,1287.26768691329,1290.40927933047,1293.55087174880,1296.69246416827,1299.83405658887,1302.97564901059,1306.11724143343,1309.25883385738,1312.40042628243,1315.54201870857,1318.68361113579,1321.82520356409,1324.96679599345,1328.10838842388,1331.24998085536,1334.39157328789,1337.53316572145,1340.67475815605,1343.81635059167,1346.95794302831,1350.09953546595,1353.24112790460,1356.38272034425,1359.52431278488,1362.66590522650,1365.80749766909,1368.94909011265,1372.09068255717,1375.23227500264,1378.37386744907,1381.51545989644,1384.65705234474,1387.79864479397,1390.94023724413,1394.08182969520,1397.22342214718,1400.36501460007,1403.50660705385,1406.64819950853,1409.78979196410,1412.93138442054,1416.07297687786,1419.21456933605,1422.35616179510,1425.49775425501,1428.63934671578,1431.78093917738,1434.92253163983,1438.06412410312,1441.20571656723,1444.34730903217,1447.48890149792,1450.63049396449,1453.77208643187,1456.91367890005,1460.05527136903,1463.19686383880,1466.33845630936,1469.48004878071,1472.62164125283,1475.76323372572,1478.90482619938,1482.04641867380,1485.18801114898,1488.32960362492,1491.47119610160,1494.61278857903,1497.75438105719,1500.89597353609,1504.03756601572,1507.17915849608,1510.32075097715,1513.46234345894,1516.60393594145,1519.74552842466,1522.88712090857,1526.02871339318,1529.17030587849,1532.31189836449,1535.45349085117,1538.59508333853,1541.73667582657,1544.87826831529,1548.01986080467,1551.16145329472,1554.30304578543,1557.44463827680,1560.58623076882,1563.72782326149,1566.86941575480,1570.01100824876,1573.15260074335,1576.29419323858,1579.43578573444,1582.57737823092,1585.71897072803,1588.86056322575,1592.00215572409,1595.14374822305,1598.28534072260,1601.42693322277,1604.56852572353,1607.71011822490,1610.85171072685,1613.99330322940,1617.13489573253,1620.27648823625,1623.41808074054,1626.55967324542,1629.70126575086,1632.84285825688,1635.98445076346,1639.12604327061,1642.26763577832,1645.40922828658,1648.55082079540,1651.69241330477,1654.83400581469,1657.97559832515,1661.11719083615,1664.25878334769,1667.40037585977,1670.54196837237,1673.68356088551,1676.82515339918,1679.96674591336,1683.10833842807,1686.24993094330,1689.39152345904,1692.53311597529,1695.67470849205,1698.81630100931,1701.95789352708,1705.09948604535,1708.24107856412,1711.38267108338,1714.52426360314,1717.66585612338,1720.80744864411,1723.94904116533,1727.09063368703,1730.23222620920,1733.37381873186,1736.51541125498,1739.65700377858,1742.79859630265,1745.94018882718,1749.08178135217,1752.22337387763,1755.36496640355,1758.50655892992,1761.64815145675,1764.78974398402,1767.93133651175,1771.07292903992,1774.21452156854,1777.35611409760,1780.49770662709,1783.63929915703,1786.78089168740,1789.92248421820,1793.06407674943,1796.20566928109,1799.34726181318,1802.48885434569,1805.63044687862,1808.77203941197,1811.91363194574,1815.05522447992,1818.19681701451,1821.33840954952,1824.48000208493,1827.62159462075,1830.76318715698,1833.90477969360,1837.04637223063,1840.18796476805,1843.32955730587,1846.47114984409,1849.61274238270,1852.75433492169,1855.89592746107,1859.03752000084,1862.17911254100,1865.32070508154,1868.46229762245,1871.60389016375,1874.74548270542,1877.88707524746,1881.02866778988,1884.17026033267,1887.31185287583,1890.45344541935,1893.59503796324,1896.73663050749,1899.87822305211,1903.01981559708,1906.16140814242,1909.30300068810,1912.44459323415,1915.58618578054,1918.72777832729,1921.86937087439,1925.01096342183,1928.15255596962,1931.29414851776,1934.43574106623,1937.57733361505,1940.71892616421,1943.86051871370,1947.00211126353,1950.14370381370,1953.28529636419,1956.42688891502,1959.56848146618,1962.71007401767,1965.85166656948,1968.99325912161,1972.13485167407,1975.27644422686,1978.41803677996,1981.55962933338,1984.70122188712,1987.84281444117,1990.98440699554,1994.12599955022,1997.26759210521,2000.40918466051,2003.55077721612,2006.69236977203,2009.83396232825,2012.97555488478,2016.11714744161,2019.25873999874,2022.40033255616,2025.54192511389,2028.68351767191,2031.82511023023,2034.96670278885,2038.10829534775,2041.24988790695,2044.39148046644,2047.53307302622,2050.67466558628,2053.81625814663,2056.95785070726,2060.09944326818,2063.24103582938,2066.38262839086,2069.52422095263,2072.66581351466,2075.80740607698,2078.94899863957,2082.09059120244,2085.23218376558,2088.37377632899,2091.51536889268,2094.65696145663,2097.79855402085,2100.94014658534,2104.08173915010,2107.22333171512,2110.36492428040,2113.50651684594,2116.64810941175,2119.78970197782,2122.93129454415,2126.07288711073,2129.21447967757,2132.35607224467,2135.49766481202,2138.63925737963,2141.78084994748,2144.92244251559,2148.06403508395,2151.20562765256,2154.34722022141,2157.48881279051,2160.63040535986,2163.77199792945,2166.91359049929,2170.05518306937,2173.19677563969,2176.33836821024,2179.47996078104,2182.62155335208,2185.76314592336,2188.90473849487,2192.04633106661,2195.18792363860,2198.32951621081,2201.47110878326,2204.61270135593,2207.75429392884,2210.89588650198,2214.03747907534,2217.17907164894,2220.32066422275,2223.46225679680,2226.60384937107,2229.74544194556,2232.88703452028,2236.02862709521,2239.17021967037,2242.31181224575,2245.45340482134,2248.59499739716,2251.73658997319,2254.87818254944,2258.01977512590,2261.16136770258,2264.30296027946,2267.44455285657,2270.58614543388,2273.72773801141,2276.86933058914,2280.01092316709,2283.15251574524,2286.29410832360,2289.43570090216,2292.57729348094,2295.71888605991,2298.86047863909,2302.00207121848,2305.14366379806,2308.28525637785,2311.42684895784,2314.56844153802,2317.71003411841,2320.85162669899,2323.99321927978,2327.13481186076,2330.27640444193,2333.41799702330,2336.55958960486,2339.70118218662,2342.84277476857,2345.98436735071,2349.12595993304,2352.26755251557,2355.40914509828,2358.55073768118,2361.69233026427,2364.83392284755,2367.97551543101,2371.11710801466,2374.25870059849,2377.40029318251,2380.54188576671,2383.68347835110,2386.82507093567,2389.96666352042,2393.10825610534,2396.24984869045,2399.39144127574,2402.53303386121,2405.67462644686,2408.81621903268,2411.95781161868,2415.09940420485,2418.24099679120,2421.38258937773,2424.52418196443,2427.66577455130,2430.80736713834,2433.94895972556,2437.09055231294,2440.23214490050,2443.37373748823,2446.51533007613,2449.65692266419,2452.79851525242,2455.94010784082,2459.08170042939,2462.22329301812,2465.36488560702,2468.50647819608,2471.64807078531,2474.78966337470,2477.93125596425,2481.07284855397,2484.21444114384,2487.35603373388,2490.49762632408,2493.63921891443,2496.78081150495,2499.92240409563,2503.06399668646,2506.20558927745,2509.34718186860,2512.48877445990,2515.63036705136,2518.77195964297,2521.91355223474,2525.05514482666,2528.19673741874,2531.33833001097,2534.47992260334,2537.62151519588,2540.76310778856,2543.90470038139,2547.04629297438,2550.18788556751,2553.32947816079,2556.47107075422,2559.61266334779,2562.75425594152,2565.89584853539,2569.03744112941,2572.17903372357,2575.32062631788,2578.46221891233,2581.60381150692,2584.74540410166,2587.88699669654,2591.02858929157,2594.17018188673,2597.31177448204,2600.45336707749,2603.59495967308,2606.73655226881,2609.87814486467,2613.01973746068,2616.16133005682,2619.30292265311,2622.44451524953,2625.58610784608,2628.72770044278,2631.86929303961,2635.01088563657,2638.15247823367,2641.29407083090,2644.43566342827,2647.57725602577,2650.71884862340,2653.86044122117,2657.00203381907,2660.14362641710,2663.28521901526,2666.42681161355,2669.56840421197,2672.70999681052,2675.85158940920,2678.99318200801,2682.13477460695,2685.27636720602,2688.41795980521,2691.55955240453,2694.70114500398,2697.84273760355,2700.98433020325,2704.12592280307,2707.26751540302,2710.40910800309,2713.55070060329,2716.69229320361,2719.83388580405,2722.97547840462,2726.11707100530,2729.25866360611,2732.40025620704,2735.54184880810,2738.68344140927,2741.82503401056,2744.96662661197,2748.10821921350,2751.24981181516,2754.39140441692,2757.53299701881,2760.67458962082,2763.81618222294,2766.95777482518,2770.09936742753,2773.24096003000,2776.38255263259,2779.52414523529,2782.66573783811,2785.80733044104,2788.94892304409,2792.09051564725,2795.23210825052,2798.37370085391,2801.51529345741,2804.65688606102,2807.79847866474,2810.94007126857,2814.08166387252,2817.22325647657,2820.36484908074,2823.50644168502,2826.64803428940,2829.78962689390,2832.93121949850,2836.07281210322,2839.21440470804,2842.35599731296,2845.49758991800,2848.63918252314,2851.78077512839,2854.92236773375,2858.06396033921,2861.20555294478,2864.34714555045,2867.48873815623,2870.63033076211,2873.77192336810,2876.91351597419,2880.05510858039,2883.19670118669,2886.33829379309,2889.47988639959,2892.62147900620,2895.76307161290,2898.90466421971,2902.04625682662,2905.18784943364,2908.32944204075,2911.47103464796,2914.61262725527,2917.75421986269,2920.89581247020,2924.03740507781,2927.17899768552,2930.32059029333,2933.46218290123,2936.60377550923,2939.74536811734,2942.88696072553,2946.02855333383,2949.17014594222,2952.31173855071,2955.45333115929,2958.59492376797,2961.73651637675,2964.87810898561,2968.01970159458,2971.16129420364,2974.30288681279,2977.44447942204,2980.58607203138,2983.72766464081,2986.86925725033,2990.01084985995,2993.15244246966,2996.29403507946,2999.43562768936,3002.57722029935,3005.71881290942,3008.86040551959,3012.00199812985,3015.14359074020,3018.28518335064,3021.42677596116,3024.56836857178,3027.70996118249,3030.85155379329,3033.99314640417,3037.13473901514,3040.27633162620,3043.41792423735,3046.55951684859,3049.70110945991,3052.84270207132,3055.98429468282,3059.12588729440,3062.26747990607,3065.40907251783,3068.55066512967,3071.69225774160,3074.83385035361,3077.97544296571,3081.11703557789,3084.25862819016,3087.40022080251,3090.54181341494,3093.68340602746,3096.82499864006,3099.96659125274,3103.10818386551,3106.24977647836,3109.39136909129,3112.53296170430,3115.67455431740,3118.81614693058,3121.95773954383,3125.09933215717,3128.24092477059,3131.38251738409,3134.52410999768,3137.66570261134,3140.80729522508];
        an = bessel0zeros(1:NN);
        anRho = bsxfun(@times,an,Rho);
    case 1 % J1
        bessel1zeros = [0,3.83170597020751,7.01558666981562,10.1734681350627,13.3236919363142,16.4706300508776,19.6158585104682,22.7600843805928,25.9036720876184,29.0468285349169,32.1896799109744,35.3323075500839,38.4747662347716,41.6170942128145,44.7593189976528,47.9014608871855,51.0435351835715,54.1855536410613,57.3275254379010,60.4694578453475,63.6113566984812,66.7532267340985,69.8950718374958,73.0368952255738,76.1786995846415,79.3204871754763,82.4622599143736,85.6040194363502,88.7457671449263,91.8875042516950,95.0292318080447,98.1709507307908,101.312661823039,104.454365791283,107.596063259509,110.737754780899,113.879440847595,117.021121898892,120.162798328149,123.304470488636,126.446138698517,129.587803245104,132.729464388510,135.871122364789,139.012777388660,142.154429655859,145.296079345196,148.437726620342,151.579371631401,154.721014516286,157.862655401930,161.004294405362,164.145931634650,167.287567189744,170.429201163227,173.570833640976,176.712464702764,179.854094422788,182.995722870153,186.137350109296,189.278976200376,192.420601199626,195.562225159663,198.703848129777,201.845470156191,204.987091282292,208.128711548850,211.270330994208,214.411949654462,217.553567563624,220.695184753769,223.836801255172,226.978417096429,230.120032304579,233.261646905201,236.403260922514,239.544874379470,242.686487297829,245.828099698240,248.969711600310,252.111323022669,255.252933983028,258.394544498240,261.536154584344,264.677764256622,267.819373529635,270.960982417271,274.102590932781,277.244199088815,280.385806897456,283.527414370251,286.669021518243,289.810628351994,292.952234881614,296.093841116782,299.235447066774,302.377052740478,305.518658146416,308.660263292764,311.801868187371,314.943472837767,318.085077251190,321.226681434593,324.368285394658,327.509889137813,330.651492670239,333.793095997889,336.934699126488,340.076302061554,343.217904808401,346.359507372151,349.501109757741,352.642711969932,355.784314013319,358.925915892333,362.067517611253,365.209119174210,368.350720585196,371.492321848065,374.633922966544,377.775523944235,380.917124784621,384.058725491072,387.200326066848,390.341926515104,393.483526838895,396.625127041178,399.766727124817,402.908327092588,406.049926947180,409.191526691201,412.333126327177,415.474725857559,418.616325284726,421.757924610982,424.899523838567,428.041122969653,431.182722006349,434.324320950704,437.465919804707,440.607518570290,443.749117249332,446.890715843658,450.032314355042,453.173912785208,456.315511135835,459.457109408554,462.598707604951,465.740305726573,468.881903774921,472.023501751458,475.165099657610,478.306697494762,481.448295264266,484.589892967438,487.731490605558,490.873088179877,494.014685691610,497.156283141946,500.297880532039,503.439477863019,506.581075135985,509.722672352010,512.864269512139,516.005866617394,519.147463668772,522.289060667243,525.430657613758,528.572254509243,531.713851354602,534.855448150718,537.997044898455,541.138641598654,544.280238252139,547.421834859715,550.563431422166,553.705027940262,556.846624414753,559.988220846372,563.129817235838,566.271413583851,569.413009891099,572.554606158251,575.696202385965,578.837798574883,581.979394725632,585.120990838828,588.262586915072,591.404182954953,594.545778959048,597.687374927921,600.828970862124,603.970566762199,607.112162628675,610.253758462071,613.395354262895,616.536950031646,619.678545768810,622.820141474867,625.961737150284,629.103332795521,632.244928411027,635.386523997244,638.528119554603,641.669715083528,644.811310584436,647.952906057734,651.094501503820,654.236096923088,657.377692315922,660.519287682699,663.660883023789,666.802478339555,669.944073630353,673.085668896533,676.227264138439,679.368859356406,682.510454550766,685.652049721842,688.793644869954,691.935239995414,695.076835098530,698.218430179603,701.360025238929,704.501620276799,707.643215293499,710.784810289309,713.926405264506,717.068000219361,720.209595154139,723.351190069102,726.492784964507,729.634379840607,732.775974697650,735.917569535881,739.059164355538,742.200759156858,745.342353940074,748.483948705411,751.625543453096,754.767138183349,757.908732896385,761.050327592419,764.191922271660,767.333516934314,770.475111580584,773.616706210670,776.758300824768,779.899895423072,783.041490005771,786.183084573053,789.324679125101,792.466273662097,795.607868184219,798.749462691643,801.891057184541,805.032651663084,808.174246127438,811.315840577769,814.457435014239,817.599029437008,820.740623846233,823.882218242069,827.023812624668,830.165406994182,833.307001350756,836.448595694539,839.590190025673,842.731784344300,845.873378650558,849.014972944586,852.156567226519,855.298161496489,858.439755754629,861.581350001067,864.722944235932,867.864538459348,871.006132671440,874.147726872330,877.289321062138,880.430915240983,883.572509408982,886.714103566249,889.855697712900,892.997291849045,896.138885974795,899.280480090260,902.422074195546,905.563668290759,908.705262376005,911.846856451386,914.988450517003,918.130044572957,921.271638619347,924.413232656270,927.554826683822,930.696420702099,933.838014711193,936.979608711198,940.121202702205,943.262796684302,946.404390657580,949.545984622125,952.687578578025,955.829172525363,958.970766464225,962.112360394693,965.253954316849,968.395548230775,971.537142136550,974.678736034253,977.820329923961,980.961923805752,984.103517679701,987.245111545884,990.386705404374,993.528299255243,996.669893098565,999.811486934410,1002.95308076285,1006.09467458395,1009.23626839778,1012.37786220442,1015.51945600391,1018.66104979634,1021.80264358177,1024.94423736026,1028.08583113187,1031.22742489668,1034.36901865473,1037.51061240609,1040.65220615083,1043.79379988899,1046.93539362065,1050.07698734586,1053.21858106467,1056.36017477715,1059.50176848335,1062.64336218332,1065.78495587713,1068.92654956482,1072.06814324645,1075.20973692208,1078.35133059174,1081.49292425551,1084.63451791342,1087.77611156554,1090.91770521190,1094.05929885256,1097.20089248756,1100.34248611697,1103.48407974081,1106.62567335915,1109.76726697203,1112.90886057949,1116.05045418158,1119.19204777834,1122.33364136983,1125.47523495608,1128.61682853713,1131.75842211304,1134.90001568384,1138.04160924958,1141.18320281029,1144.32479636603,1147.46638991682,1150.60798346272,1153.74957700375,1156.89117053997,1160.03276407141,1163.17435759810,1166.31595112009,1169.45754463741,1172.59913815011,1175.74073165821,1178.88232516176,1182.02391866080,1185.16551215535,1188.30710564545,1191.44869913114,1194.59029261246,1197.73188608943,1200.87347956210,1204.01507303049,1207.15666649464,1210.29825995458,1213.43985341035,1216.58144686197,1219.72304030948,1222.86463375292,1226.00622719230,1229.14782062767,1232.28941405905,1235.43100748648,1238.57260090998,1241.71419432959,1244.85578774533,1247.99738115723,1251.13897456532,1254.28056796964,1257.42216137020,1260.56375476704,1263.70534816019,1266.84694154966,1269.98853493550,1273.13012831772,1276.27172169635,1279.41331507143,1282.55490844297,1285.69650181100,1288.83809517555,1291.97968853664,1295.12128189430,1298.26287524855,1301.40446859941,1304.54606194692,1307.68765529110,1310.82924863196,1313.97084196954,1317.11243530386,1320.25402863493,1323.39562196279,1326.53721528746,1329.67880860895,1332.82040192730,1335.96199524252,1339.10358855464,1342.24518186367,1345.38677516964,1348.52836847257,1351.66996177249,1354.81155506940,1357.95314836334,1361.09474165433,1364.23633494237,1367.37792822751,1370.51952150974,1373.66111478910,1376.80270806561,1379.94430133928,1383.08589461013,1386.22748787819,1389.36908114346,1392.51067440598,1395.65226766576,1398.79386092281,1401.93545417715,1405.07704742882,1408.21864067781,1411.36023392415,1414.50182716786,1417.64342040895,1420.78501364745,1423.92660688336,1427.06820011671,1430.20979334751,1433.35138657579,1436.49297980155,1439.63457302481,1442.77616624559,1445.91775946391,1449.05935267977,1452.20094589321,1455.34253910423,1458.48413231284,1461.62572551908,1464.76731872294,1467.90891192444,1471.05050512360,1474.19209832044,1477.33369151497,1480.47528470721,1483.61687789716,1486.75847108484,1489.90006427028,1493.04165745347,1496.18325063444,1499.32484381320,1502.46643698977,1505.60803016415,1508.74962333636,1511.89121650642,1515.03280967433,1518.17440284012,1521.31599600379,1524.45758916536,1527.59918232484,1530.74077548224,1533.88236863758,1537.02396179087,1540.16555494212,1543.30714809135,1546.44874123856,1549.59033438377,1552.73192752698,1555.87352066823,1559.01511380750,1562.15670694483,1565.29830008021,1568.43989321366,1571.58148634519,1574.72307947482,1577.86467260255,1581.00626572839,1584.14785885237,1587.28945197448,1590.43104509474,1593.57263821316,1596.71423132975,1599.85582444452,1602.99741755749,1606.13901066865,1609.28060377803,1612.42219688564,1615.56378999148,1618.70538309556,1621.84697619790,1624.98856929850,1628.13016239738,1631.27175549455,1634.41334859000,1637.55494168377,1640.69653477584,1643.83812786624,1646.97972095498,1650.12131404206,1653.26290712749,1656.40450021128,1659.54609329344,1662.68768637399,1665.82927945292,1668.97087253025,1672.11246560599,1675.25405868015,1678.39565175273,1681.53724482375,1684.67883789321,1687.82043096112,1690.96202402749,1694.10361709233,1697.24521015565,1700.38680321745,1703.52839627775,1706.66998933655,1709.81158239387,1712.95317544970,1716.09476850406,1719.23636155695,1722.37795460839,1725.51954765838,1728.66114070693,1731.80273375404,1734.94432679973,1738.08591984400,1741.22751288687,1744.36910592833,1747.51069896839,1750.65229200707,1753.79388504437,1756.93547808030,1760.07707111486,1763.21866414806,1766.36025717992,1769.50185021043,1772.64344323961,1775.78503626745,1778.92662929398,1782.06822231918,1785.20981534309,1788.35140836569,1791.49300138699,1794.63459440701,1797.77618742575,1800.91778044321,1804.05937345941,1807.20096647435,1810.34255948803,1813.48415250046,1816.62574551166,1819.76733852162,1822.90893153035,1826.05052453785,1829.19211754415,1832.33371054923,1835.47530355311,1838.61689655579,1841.75848955728,1844.90008255759,1848.04167555672,1851.18326855468,1854.32486155146,1857.46645454709,1860.60804754156,1863.74964053489,1866.89123352707,1870.03282651811,1873.17441950802,1876.31601249681,1879.45760548447,1882.59919847102,1885.74079145646,1888.88238444079,1892.02397742403,1895.16557040617,1898.30716338723,1901.44875636720,1904.59034934610,1907.73194232393,1910.87353530069,1914.01512827639,1917.15672125103,1920.29831422463,1923.43990719717,1926.58150016868,1929.72309313915,1932.86468610860,1936.00627907701,1939.14787204441,1942.28946501079,1945.43105797617,1948.57265094053,1951.71424390390,1954.85583686627,1957.99742982765,1961.13902278804,1964.28061574745,1967.42220870589,1970.56380166335,1973.70539461985,1976.84698757538,1979.98858052996,1983.13017348358,1986.27176643625,1989.41335938798,1992.55495233877,1995.69654528862,1998.83813823754,2001.97973118553,2005.12132413260,2008.26291707876,2011.40451002400,2014.54610296833,2017.68769591175,2020.82928885427,2023.97088179590,2027.11247473663,2030.25406767648,2033.39566061544,2036.53725355352,2039.67884649072,2042.82043942705,2045.96203236251,2049.10362529711,2052.24521823085,2055.38681116373,2058.52840409576,2061.66999702694,2064.81158995728,2067.95318288677,2071.09477581543,2074.23636874325,2077.37796167025,2080.51955459642,2083.66114752177,2086.80274044630,2089.94433337001,2093.08592629292,2096.22751921501,2099.36911213631,2102.51070505680,2105.65229797650,2108.79389089540,2111.93548381351,2115.07707673084,2118.21866964739,2121.36026256316,2124.50185547815,2127.64344839237,2130.78504130582,2133.92663421851,2137.06822713043,2140.20982004160,2143.35141295201,2146.49300586167,2149.63459877058,2152.77619167875,2155.91778458617,2159.05937749285,2162.20097039880,2165.34256330402,2168.48415620851,2171.62574911227,2174.76734201531,2177.90893491763,2181.05052781924,2184.19212072013,2187.33371362031,2190.47530651978,2193.61689941855,2196.75849231661,2199.90008521398,2203.04167811065,2206.18327100664,2209.32486390193,2212.46645679653,2215.60804969045,2218.74964258370,2221.89123547626,2225.03282836815,2228.17442125936,2231.31601414991,2234.45760703979,2237.59919992901,2240.74079281757,2243.88238570547,2247.02397859271,2250.16557147930,2253.30716436524,2256.44875725054,2259.59035013519,2262.73194301920,2265.87353590257,2269.01512878530,2272.15672166740,2275.29831454887,2278.43990742971,2281.58150030992,2284.72309318951,2287.86468606849,2291.00627894684,2294.14787182458,2297.28946470170,2300.43105757821,2303.57265045412,2306.71424332942,2309.85583620411,2312.99742907821,2316.13902195171,2319.28061482461,2322.42220769692,2325.56380056864,2328.70539343977,2331.84698631031,2334.98857918027,2338.13017204965,2341.27176491845,2344.41335778667,2347.55495065432,2350.69654352139,2353.83813638790,2356.97972925383,2360.12132211921,2363.26291498402,2366.40450784827,2369.54610071196,2372.68769357509,2375.82928643767,2378.97087929970,2382.11247216118,2385.25406502211,2388.39565788249,2391.53725074233,2394.67884360163,2397.82043646039,2400.96202931862,2404.10362217631,2407.24521503347,2410.38680789009,2413.52840074619,2416.66999360176,2419.81158645681,2422.95317931133,2426.09477216533,2429.23636501882,2432.37795787179,2435.51955072424,2438.66114357619,2441.80273642762,2444.94432927854,2448.08592212896,2451.22751497887,2454.36910782828,2457.51070067719,2460.65229352560,2463.79388637352,2466.93547922093,2470.07707206786,2473.21866491430,2476.36025776024,2479.50185060570,2482.64344345067,2485.78503629516,2488.92662913917,2492.06822198269,2495.20981482574,2498.35140766831,2501.49300051041,2504.63459335203,2507.77618619319,2510.91777903387,2514.05937187409,2517.20096471384,2520.34255755312,2523.48415039195,2526.62574323031,2529.76733606822,2532.90892890566,2536.05052174265,2539.19211457919,2542.33370741528,2545.47530025091,2548.61689308610,2551.75848592084,2554.90007875513,2558.04167158898,2561.18326442239,2564.32485725536,2567.46645008789,2570.60804291998,2573.74963575163,2576.89122858285,2580.03282141364,2583.17441424400,2586.31600707392,2589.45759990342,2592.59919273250,2595.74078556115,2598.88237838937,2602.02397121718,2605.16556404456,2608.30715687152,2611.44874969807,2614.59034252420,2617.73193534992,2620.87352817523,2624.01512100012,2627.15671382461,2630.29830664868,2633.43989947235,2636.58149229562,2639.72308511848,2642.86467794094,2646.00627076299,2649.14786358465,2652.28945640591,2655.43104922677,2658.57264204724,2661.71423486731,2664.85582768699,2667.99742050628,2671.13901332518,2674.28060614369,2677.42219896182,2680.56379177956,2683.70538459691,2686.84697741388,2689.98857023047,2693.13016304668,2696.27175586251,2699.41334867797,2702.55494149304,2705.69653430774,2708.83812712207,2711.97971993603,2715.12131274961,2718.26290556283,2721.40449837567,2724.54609118815,2727.68768400026,2730.82927681201,2733.97086962340,2737.11246243442,2740.25405524508,2743.39564805538,2746.53724086533,2749.67883367491,2752.82042648414,2755.96201929302,2759.10361210154,2762.24520490971,2765.38679771752,2768.52839052499,2771.66998333211,2774.81157613888,2777.95316894531,2781.09476175139,2784.23635455712,2787.37794736251,2790.51954016756,2793.66113297227,2796.80272577664,2799.94431858068,2803.08591138437,2806.22750418773,2809.36909699075,2812.51068979344,2815.65228259580,2818.79387539783,2821.93546819952,2825.07706100089,2828.21865380192,2831.36024660264,2834.50183940302,2837.64343220308,2840.78502500281,2843.92661780223,2847.06821060132,2850.20980340009,2853.35139619854,2856.49298899667,2859.63458179448,2862.77617459198,2865.91776738916,2869.05936018603,2872.20095298258,2875.34254577882,2878.48413857475,2881.62573137037,2884.76732416568,2887.90891696068,2891.05050975538,2894.19210254977,2897.33369534385,2900.47528813763,2903.61688093110,2906.75847372428,2909.90006651715,2913.04165930972,2916.18325210199,2919.32484489396,2922.46643768564,2925.60803047702,2928.74962326810,2931.89121605889,2935.03280884939,2938.17440163959,2941.31599442950,2944.45758721912,2947.59918000845,2950.74077279749,2953.88236558624,2957.02395837471,2960.16555116289,2963.30714395078,2966.44873673839,2969.59032952571,2972.73192231276,2975.87351509952,2979.01510788600,2982.15670067220,2985.29829345812,2988.43988624376,2991.58147902913,2994.72307181422,2997.86466459903,3001.00625738357,3004.14785016784,3007.28944295183,3010.43103573555,3013.57262851900,3016.71422130217,3019.85581408508,3022.99740686772,3026.13899965009,3029.28059243220,3032.42218521403,3035.56377799561,3038.70537077692,3041.84696355796,3044.98855633874,3048.13014911926,3051.27174189952,3054.41333467952,3057.55492745925,3060.69652023873,3063.83811301795,3066.97970579691,3070.12129857562,3073.26289135407,3076.40448413227,3079.54607691021,3082.68766968790,3085.82926246533,3088.97085524251,3092.11244801945,3095.25404079613,3098.39563357256,3101.53722634874,3104.67881912468,3107.82041190037,3110.96200467581,3114.10359745100,3117.24519022595,3120.38678300066,3123.52837577512,3126.66996854934,3129.81156132332,3132.95315409705,3136.09474687055,3139.23633964380];
        an = bessel1zeros(1:NN);
        anRho = bsxfun(@times,an,Rho);
    case 2 % linear, 2.7m-2
        an = 2.7*[1:NN]-2;
        anRho = bsxfun(@times,an,Rho);
    case 3 % Dini series
        diniseries = [0.616974766101560,3.88350553129723,7.04402929220661,10.1931056369408,13.3386932202932,16.4827678087316,19.6260513413601,22.7688697726206,25.9113916970579,29.0537130435692,32.1958924029986,35.3379675779832,38.4799640490770,41.6218996159417,44.7637870881355,47.9056359189870,51.0474532370593,54.1892445192960,57.3310140431034,60.4727651976641,63.6145007030903,66.7562227677477,69.8979332031861,73.0396335094290,76.1813249391744,79.3230085467469,82.4646852258676,85.6063557391112,88.7480207411091,91.8896807969950,95.0313363971934,98.1729879693695,101.314635888157,104.456280483130,107.597922045380,110.739560832973,113.881197075503,117.022830977916,120.164462723727,123.306092477753,126.447720388431,129.589346589811,132.730971203250,135.872594338883,139.014216096891,142.155836568601,145.297455837440,148.439073979776,151.580691065645,154.722307159394,157.863922320252,161.005536602822,164.147150057530,167.288762731011,170.430374666466,173.571985903965,176.713596480731,179.855206431386,182.996815788173,186.138424581161,189.280032838421,192.421640586191,195.563247849025,198.704854649922,201.846461010449,204.988066950854,208.129672490160,211.271277646259,214.412882435994,217.554486875237,220.696090978954,223.837694761273,226.979298235538,230.120901414365,233.262504309691,236.404106932817,239.545709294454,242.687311404755,245.828913273357,248.970514909407,252.112116321601,255.253717518202,258.395318507075,261.536919295705,264.678519891221,267.820120300420,270.961720529782,274.103320585491,277.244920473449,280.386520199295,283.528119768417,286.669719185969,289.811318456879,292.952917585864,296.094516577443,299.236115435942,302.377714165511,305.519312770125,308.660911253600,311.802509619598,314.944107871634,318.085706013085,321.227304047196,324.368901977085,327.510499805751,330.652097536079,333.793695170846,336.935292712725,340.076890164291,343.218487528023,346.360084806311,349.501682001459,352.643279115689,355.784876151145,358.926473109895,362.068069993936,365.209666805196,368.351263545537,371.492860216758,374.634456820598,377.776053358737,380.917649832803,384.059246244366,387.200842594948,390.342438886022,393.484035119013,396.625631295301,399.767227416223,402.908823483074,406.050419497109,409.192015459544,412.333611371560,415.475207234298,418.616803048870,421.758398816352,424.899994537787,428.041590214190,431.183185846544,434.324781435807,437.466376982906,440.607972488743,443.749567954195,446.891163380112,450.032758767324,453.174354116635,456.315949428828,459.457544704664,462.599139944884,465.740735150209,468.882330321339,472.023925458959,475.165520563732,478.307115636306,481.448710677311,484.590305687361,487.731900667054,490.873495616973,494.015090537687,497.156685429748,500.298280293696,503.439875130058,506.581469939347,509.723064722064,512.864659478697,516.006254209722,519.147848915604,522.289443596797,525.431038253744,528.572632886877,531.714227496618,534.855822083379,537.997416647563,541.139011189563,544.280605709764,547.422200208540,550.563794686259,553.705389143278,556.846983579949,559.988577996613,563.130172393605,566.271766771253,569.413361129877,572.554955469791,575.696549791299,578.838144094703,581.979738380295,585.121332648363,588.262926899186,591.404521133040,594.546115350194,597.687709550911,600.829303735449,603.970897904061,607.112492056993,610.254086194488,613.395680316782,616.537274424110,619.678868516697,622.820462594767,625.962056658539,629.103650708227,632.245244744040,635.386838766185,638.528432774864,641.670026770273,644.811620752608,647.953214722058,651.094808678809,654.236402623046,657.377996554946,660.519590474687,663.661184382440,666.802778278376,669.944372162660,673.085966035455,676.227559896923,679.369153747219,682.510747586499,685.652341414913,688.793935232610,691.935529039737,695.077122836436,698.218716622849,701.360310399113,704.501904165364,707.643497921736,710.785091668360,713.926685405364,717.068279132875,720.209872851017,723.351466559912,726.493060259680,729.634653950439,732.776247632305,735.917841305392,739.059434969811,742.201028625673,745.342622273086,748.484215912156,751.625809542989,754.767403165686,757.908996780349,761.050590387077,764.192183985969,767.333777577120,770.475371160626,773.616964736579,776.758558305071,779.900151866192,783.041745420031,786.183338966676,789.324932506211,792.466526038722,795.608119564293,798.749713083003,801.891306594936,805.032900100169,808.174493598780,811.316087090848,814.457680576447,817.599274055653,820.740867528537,823.882460995174,827.024054455633,830.165647909986,833.307241358301,836.448834800646,839.590428237089,842.732021667695,845.873615092529,849.015208511655,852.156801925137,855.298395333037,858.439988735415,861.581582132333,864.723175523850,867.864768910025,871.006362290914,874.147955666576,877.289549037067,880.431142402442,883.572735762754,886.714329118060,889.855922468410,892.997515813858,896.139109154455,899.280702490252,902.422295821299,905.563889147646,908.705482469341,911.847075786432,914.988669098967,918.130262406993,921.271855710555,924.413449009699,927.555042304471,930.696635594914,933.838228881072,936.979822162988,940.121415440705,943.263008714264,946.404601983707,949.546195249076,952.687788510409,955.829381767747,958.970975021130,962.112568270596,965.254161516183,968.395754757928,971.537347995871,974.678941230046,977.820534460490,980.962127687240,984.103720910330,987.245314129796,990.386907345672,993.528500557991,996.670093766789,999.811686972097,1002.95328017395,1006.09487337238,1009.23646656741,1012.37805975909,1015.51965294744,1018.66124613248,1021.80283931426,1024.94443249281,1028.08602566814,1031.22761884029,1034.36921200930,1037.51080517518,1040.65239833797,1043.79399149770,1046.93558465439,1050.07717780806,1053.21877095876,1056.36036410649,1059.50195725130,1062.64355039320,1065.78514353223,1068.92673666840,1072.06832980174,1075.20992293228,1078.35151606004,1081.49310918504,1084.63470230732,1087.77629542688,1090.91788854376,1094.05948165799,1097.20107476957,1100.34266787854,1103.48426098492,1106.62585408872,1109.76744718998,1112.90904028871,1116.05063338493,1119.19222647867,1122.33381956994,1125.47541265877,1128.61700574518,1131.75859882918,1134.90019191080,1138.04178499006,1141.18337806698,1144.32497114157,1147.46656421385,1150.60815728385,1153.74975035158,1156.89134341706,1160.03293648031,1163.17452954135,1166.31612260019,1169.45771565686,1172.59930871137,1175.74090176373,1178.88249481397,1182.02408786210,1185.16568090813,1188.30727395210,1191.44886699400,1194.59046003386,1197.73205307170,1200.87364610752,1204.01523914135,1207.15683217320,1210.29842520309,1213.44001823103,1216.58161125703,1219.72320428112,1222.86479730330,1226.00639032360,1229.14798334202,1232.28957635858,1235.43116937329,1238.57276238617,1241.71435539724,1244.85594840650,1247.99754141396,1251.13913441966,1254.28072742358,1257.42232042576,1260.56391342620,1263.70550642492,1266.84709942192,1269.98869241722,1273.13028541084,1276.27187840279,1279.41347139307,1282.55506438170,1285.69665736870,1288.83825035407,1291.97984333782,1295.12143631998,1298.26302930054,1301.40462227953,1304.54621525695,1307.68780823281,1310.82940120713,1313.97099417991,1317.11258715117,1320.25418012092,1323.39577308917,1326.53736605593,1329.67895902121,1332.82055198502,1335.96214494737,1339.10373790827,1342.24533086773,1345.38692382577,1348.52851678238,1351.67010973759,1354.81170269140,1357.95329564382,1361.09488859486,1364.23648154453,1367.37807449284,1370.51966743980,1373.66126038541,1376.80285332970,1379.94444627266,1383.08603921430,1386.22763215464,1389.36922509369,1392.51081803144,1395.65241096792,1398.79400390312,1401.93559683707,1405.07718976976,1408.21878270120,1411.36037563141,1414.50196856039,1417.64356148814,1420.78515441469,1423.92674734003,1427.06834026417,1430.20993318713,1433.35152610891,1436.49311902951,1439.63471194894,1442.77630486722,1445.91789778435,1449.05949070034,1452.20108361519,1455.34267652891,1458.48426944151,1461.62586235300,1464.76745526339,1467.90904817267,1471.05064108086,1474.19223398797,1477.33382689399,1480.47541979895,1483.61701270284,1486.75860560568,1489.90019850746,1493.04179140820,1496.18338430790,1499.32497720657,1502.46657010421,1505.60816300084,1508.74975589645,1511.89134879106,1515.03294168467,1518.17453457728,1521.31612746891,1524.45772035956,1527.59931324923,1530.74090613793,1533.88249902567,1537.02409191246,1540.16568479829,1543.30727768317,1546.44887056712,1549.59046345013,1552.73205633221,1555.87364921337,1559.01524209362,1562.15683497295,1565.29842785138,1568.44002072890,1571.58161360553,1574.72320648127,1577.86479935612,1581.00639223010,1584.14798510320,1587.28957797544,1590.43117084680,1593.57276371732,1596.71435658697,1599.85594945578,1602.99754232374,1606.13913519087,1609.28072805716,1612.42232092263,1615.56391378727,1618.70550665109,1621.84709951409,1624.98869237629,1628.13028523768,1631.27187809827,1634.41347095806,1637.55506381707,1640.69665667529,1643.83824953272,1646.97984238938,1650.12143524526,1653.26302810038,1656.40462095473,1659.54621380832,1662.68780666115,1665.82939951324,1668.97099236457,1672.11258521517,1675.25417806502,1678.39577091414,1681.53736376253,1684.67895661019,1687.82054945713,1690.96214230335,1694.10373514886,1697.24532799365,1700.38692083774,1703.52851368113,1706.67010652382,1709.81169936581,1712.95329220712,1716.09488504773,1719.23647788766,1722.37807072692,1725.51966356549,1728.66125640340,1731.80284924063,1734.94444207720,1738.08603491311,1741.22762774836,1744.36922058296,1747.51081341690,1750.65240625020,1753.79399908285,1756.93559191487,1760.07718474624,1763.21877757699,1766.36037040710,1769.50196323659,1772.64355606545,1775.78514889369,1778.92674172132,1782.06833454833,1785.20992737473,1788.35152020053,1791.49311302572,1794.63470585031,1797.77629867430,1800.91789149770,1804.05948432050,1807.20107714272,1810.34266996435,1813.48426278541,1816.62585560588,1819.76744842577,1822.90904124509,1826.05063406385,1829.19222688203,1832.33381969965,1835.47541251671,1838.61700533321,1841.75859814915,1844.90019096454,1848.04178377938,1851.18337659368,1854.32496940743,1857.46656222063,1860.60815503330,1863.74974784544,1866.89134065703,1870.03293346810,1873.17452627864,1876.31611908865,1879.45771189815,1882.59930470712,1885.74089751557,1888.88249032351,1892.02408313093,1895.16567593785,1898.30726874425,1901.44886155016,1904.59045435556,1907.73204716046,1910.87363996486,1914.01523276877,1917.15682557218,1920.29841837511,1923.44001117754,1926.58160397950,1929.72319678096,1932.86478958195,1936.00638238246,1939.14797518249,1942.28956798205,1945.43116078114,1948.57275357976,1951.71434637791,1954.85593917560,1957.99753197283,1961.13912476959,1964.28071756590,1967.42231036175,1970.56390315715,1973.70549595209,1976.84708874659,1979.98868154064,1983.13027433424,1986.27186712740,1989.41345992012,1992.55505271241,1995.69664550425,1998.83823829566,2001.97983108664,2005.12142387719,2008.26301666731,2011.40460945700,2014.54620224627,2017.68779503512,2020.82938782354,2023.97098061155,2027.11257339914,2030.25416618631,2033.39575897308,2036.53735175943,2039.67894454537,2042.82053733091,2045.96213011604,2049.10372290076,2052.24531568509,2055.38690846901,2058.52850125254,2061.67009403567,2064.81168681841,2067.95327960076,2071.09487238271,2074.23646516428,2077.37805794546,2080.51965072625,2083.66124350666,2086.80283628669,2089.94442906634,2093.08602184561,2096.22761462450,2099.36920740302,2102.51080018116,2105.65239295894,2108.79398573634,2111.93557851337,2115.07717129004,2118.21876406634,2121.36035684228,2124.50194961786,2127.64354239308,2130.78513516794,2133.92672794244,2137.06832071659,2140.20991349038,2143.35150626382,2146.49309903691,2149.63469180965,2152.77628458204,2155.91787735408,2159.05947012578,2162.20106289714,2165.34265566816,2168.48424843883,2171.62584120917,2174.76743397917,2177.90902674883,2181.05061951816,2184.19221228716,2187.33380505583,2190.47539782416,2193.61699059217,2196.75858335985,2199.90017612720,2203.04176889423,2206.18336166093,2209.32495442732,2212.46654719338,2215.60813995913,2218.74973272455,2221.89132548966,2225.03291825446,2228.17451101894,2231.31610378311,2234.45769654697,2237.59928931052,2240.74088207376,2243.88247483669,2247.02406759932,2250.16566036165,2253.30725312367,2256.44884588539,2259.59043864680,2262.73203140792,2265.87362416874,2269.01521692927,2272.15680968950,2275.29840244943,2278.43999520907,2281.58158796842,2284.72318072747,2287.86477348624,2291.00636624472,2294.14795900291,2297.28955176082,2300.43114451844,2303.57273727578,2306.71433003283,2309.85592278960,2312.99751554610,2316.13910830231,2319.28070105824,2322.42229381390,2325.56388656929,2328.70547932439,2331.84707207923,2334.98866483379,2338.13025758808,2341.27185034210,2344.41344309585,2347.55503584934,2350.69662860255,2353.83822135550,2356.97981410819,2360.12140686061,2363.26299961277,2366.40459236467,2369.54618511631,2372.68777786768,2375.82937061880,2378.97096336966,2382.11255612027,2385.25414887061,2388.39574162071,2391.53733437055,2394.67892712014,2397.82051986947,2400.96211261856,2404.10370536740,2407.24529811598,2410.38689086432,2413.52848361242,2416.67007636027,2419.81166910787,2422.95326185523,2426.09485460234,2429.23644734922,2432.37804009585,2435.51963284225,2438.66122558840,2441.80281833432,2444.94441107999,2448.08600382544,2451.22759657064,2454.36918931562,2457.51078206036,2460.65237480486,2463.79396754914,2466.93556029318,2470.07715303699,2473.21874578058,2476.36033852393,2479.50193126706,2482.64352400996,2485.78511675264,2488.92670949509,2492.06830223732,2495.20989497932,2498.35148772110,2501.49308046266,2504.63467320400,2507.77626594512,2510.91785868602,2514.05945142670,2517.20104416717,2520.34263690741,2523.48422964745,2526.62582238726,2529.76741512687,2532.90900786626,2536.05060060543,2539.19219334440,2542.33378608316,2545.47537882170,2548.61697156003,2551.75856429816,2554.90015703608,2558.04174977379,2561.18334251129,2564.32493524859,2567.46652798569,2570.60812072258,2573.74971345926,2576.89130619575,2580.03289893203,2583.17449166811,2586.31608440399,2589.45767713967,2592.59926987516,2595.74086261044,2598.88245534553,2602.02404808042,2605.16564081511,2608.30723354961,2611.44882628391,2614.59041901802,2617.73201175194,2620.87360448566,2624.01519721919,2627.15678995253,2630.29838268568,2633.43997541864,2636.58156815142,2639.72316088400,2642.86475361639,2646.00634634860,2649.14793908062,2652.28953181246,2655.43112454411,2658.57271727557,2661.71431000686,2664.85590273796,2667.99749546887,2671.13908819961,2674.28068093016,2677.42227366053,2680.56386639073,2683.70545912074,2686.84705185057,2689.98864458023,2693.13023730971,2696.27183003901,2699.41342276814,2702.55501549709,2705.69660822586,2708.83820095446,2711.97979368289,2715.12138641114,2718.26297913923,2721.40457186713,2724.54616459487,2727.68775732244,2730.82935004984,2733.97094277706,2737.11253550412,2740.25412823101,2743.39572095773,2746.53731368429,2749.67890641068,2752.82049913690,2755.96209186296,2759.10368458885,2762.24527731457,2765.38687004014,2768.52846276553,2771.67005549077,2774.81164821585,2777.95324094076,2781.09483366551,2784.23642639010,2787.37801911453,2790.51961183880,2793.66120456292,2796.80279728687,2799.94439001067,2803.08598273431,2806.22757545779,2809.36916818111,2812.51076090428,2815.65235362730,2818.79394635016,2821.93553907286,2825.07713179542,2828.21872451781,2831.36031724006,2834.50190996215,2837.64350268410,2840.78509540589,2843.92668812753,2847.06828084902,2850.20987357036,2853.35146629155,2856.49305901259,2859.63465173349,2862.77624445423,2865.91783717483,2869.05942989528,2872.20102261559,2875.34261533575,2878.48420805577,2881.62580077564,2884.76739349536,2887.90898621494,2891.05057893438,2894.19217165368,2897.33376437283,2900.47535709184,2903.61694981071,2906.75854252944,2909.90013524803,2913.04172796648,2916.18332068479,2919.32491340295,2922.46650612098,2925.60809883888,2928.74969155663,2931.89128427424,2935.03287699172,2938.17446970907,2941.31606242627,2944.45765514334,2947.59924786028,2950.74084057708,2953.88243329374,2957.02402601027,2960.16561872667,2963.30721144294,2966.44880415907,2969.59039687507,2972.73198959094,2975.87358230667,2979.01517502228,2982.15676773775,2985.29836045310,2988.43995316831,2991.58154588340,2994.72313859835,2997.86473131318,3001.00632402788,3004.14791674245,3007.28950945690,3010.43110217121,3013.57269488540,3016.71428759947,3019.85588031341,3022.99747302722,3026.13906574091,3029.28065845447,3032.42225116791,3035.56384388123,3038.70543659442,3041.84702930749,3044.98862202043,3048.13021473326,3051.27180744596,3054.41340015854,3057.55499287100,3060.69658558333,3063.83817829555,3066.97977100765,3070.12136371963,3073.26295643148,3076.40454914322,3079.54614185484,3082.68773456634,3085.82932727773,3088.97091998900,3092.11251270015,3095.25410541118,3098.39569812209,3101.53729083289,3104.67888354358,3107.82047625415,3110.96206896460,3114.10366167494,3117.24525438517,3120.38684709528,3123.52843980527,3126.67003251516,3129.81162522493,3132.95321793458,3136.09481064413,3139.23640335356];
        an = diniseries(1:NN);
        anRho = bsxfun(@times,an,Rho);
    otherwise
        error('Not supported yet!');
end

J = funBessel0(fastcom, anRho);

r = R*params.resLateral;

A = k0*params.NA*r;
A2 = A.^2;

Ab = A.*b;

J0A = funBessel0(fastcom, Ab);
J1A = A.*funBessel1(fastcom, Ab);

anJ0A = bsxfun(@times,J0A,an');
anb = an.*b;
an2 = an.^2;
B1anb = funBessel1(fastcom, anb);
B0anb = funBessel0(fastcom, anb);

Ele = bsxfun(@times,anJ0A,B1anb') - bsxfun(@times,J1A,B0anb');
domin = bsxfun(@minus, an2', A2);
Ele = Ele.*b./domin;

C1 = params.ns*params.pZ;
C2 = params.ni*(Ti - params.ti0);
C3 = params.ng*(params.tg - params.tg0);

OPDs = C1*sqrt(1-(params.NA*Rho/params.ns).^2);
OPDi = bsxfun(@times, C2,sqrt(1-(params.NA*Rho/params.ni).^2));
OPDg = C3*sqrt(1-(params.NA*Rho/params.ng).^2);

OPD = bsxfun(@plus, OPDi, OPDs+OPDg);

W = k0*OPD;
Ffun = cos(W) + 1i*sin(W);
Ci = J\Ffun;

ciEle = Ele'*Ci;

PSF0 = abs(ciEle).^2;

index1 = index+1;
index2 = index+2;
disR1 = 1-disR;

for zi = 1:params.nz
    h = PSF0(:,zi);
    slice = h(index2).*disR +  h(index1).*disR1;
    PSF(:,:,zi) = slice;
end

PSF = PSF./max(PSF(:));

end

function J = funBessel0(fastcom, X)
if(fastcom)
    J = aux_Bessel(0,X);
    J = reshape(J, size(X));
else
    J = besselj(0, X);
end
end

function J = funBessel1(fastcom, X)
if(fastcom)
    J = aux_Bessel(1,X);
    J = reshape(J, size(X));
else
    J = besselj(1, X);
end
end

